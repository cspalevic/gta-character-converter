name: Build, Deploy

on:
   push:
      branches:
         - main

jobs:
   build-deploy:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout repository 
           uses: actions/checkout@v2

         - name: Setup Node.js
           uses: actions/setup-node@v2
           with:
             node-version: 18

         - name: Install pnpm
           run: |
            curl -L https://raw.githubusercontent.com/pnpm/self-installer/master/install.js | node echo "$(pnpm bin -g)" >> $GITHUB_PATH

         - name: Setup Python3
           uses: actions/setup-python@v2
           with:
             python-version: 3.9

         - name: Install dependencies
           run: pnpm install

         - name: Deploy background jobs
           run: pnpm deploy
           env:         
             REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
             SUPABASE_PROJECT_URL: ${{ secrets.SUPABASE_PROJECT_URL }}
             SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
             AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
             AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
             AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
             SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}
